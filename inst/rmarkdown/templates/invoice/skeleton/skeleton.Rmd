---
output:
  bookdown::pdf_document2:
    number_sections: FALSE
    template: resources/template.tex
    keep_tex: FALSE
    latex_engine: pdflatex

params:
  client:
    value:
      name: "Mickey Mouse"
      street: "1313 Disneyland Drive"
      city: "Anaheim"
      zip: "92802"
      email: "mickey.mouse@disney.com"
  project:
    value:
      reference: "INV-2024-09"
      name: "Magic Kingdom Expansion"
      description: "Design and implementation of new facilities"
  author:
    value:
      name: "Bugs Bunny"
      street: "123 Carrot Lane"
      city: "Looneyville"
      zip: "54321"
      email: "bugs.bunny@looneytoons.com"
      phone: "+27 71 987 6543"
  billing:
    value:
      beneficiary: "Elmer Fudd"
      swift: "LOONYBUN"
      bank: "Acme Bank"
      branch: "100200"
      account: "9876543210"
  date: "`r lubridate::today()`"

---

```{r setup, include = FALSE}
rm(list = ls())
invisible(gc())

library(dplyr)
library(lubridate)
library(readxl)
library(rmarkdown)
library(stringr)
library(tibble)
library(tidyr)
library(janitor)
library(flextable)

knitr::opts_chunk$set(
  eval = TRUE,
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  include = TRUE,
  fig.align = "left",
  comment = "#>"
)

# determine active file's path ----
active_file <- if (interactive()) {
  normalizePath(rstudioapi::getSourceEditorContext()$path)
} else {
  normalizePath(knitr::current_input(dir = TRUE))
}

# load parameters ----
params <- yaml_front_matter(active_file)$params %>%
  lapply(function(x) {
    if (is.list(x)) x$value else x
  })

# determine file's resources ----
resources <- fs::path_abs(
  path = "resources",
  start = dirname(active_file)
)

# default table formatting ----
source(file.path(resources, "defaults.R"))
```

```{r sessions}
sessions <- file.path(resources, "timesheet.xlsx") %>%
  read_xlsx() %>%
  clean_names() %>%
  mutate(date = ymd(date, tz = Sys.timezone())) %>%
  mutate(across(
    start:end,
    ~ paste0(
      format(date, "%Y-%m-%d"),
      " ",
      format(., "%H:%M")
    ) %>%
      ymd_hm(tz = Sys.timezone())
  )) %>%
  arrange(start) %>%
  mutate(index = str_pad(row_number(), 3, pad = "0")) %>%
  select(-any_of(c("hours", "minutes"))) %>%
  mutate(hours = as.numeric(difftime(end, start, units = "hours")))
```

```{r rates}
rates <- tibble(
  code = c("X", "Y", "Z"),
  item = c("Design", "Impact Study", "Construction"),
  rate = c(500, 200, 600)
)

sessions <- sessions %>%
  left_join(rates, by = "code") %>%
  mutate(subtotal = hours * rate)
```

```{r bill}
bill <- sessions %>%
  group_by(code, item) %>%
  summarise(
    sessions = n_distinct(index),
    hours = sum(hours, na.rm = TRUE),
    rate = unique(rate),
    subtotal = sum(subtotal, na.rm = TRUE),
    .groups = "drop"
  )

bill_total <- bill %>%
  summarise(
    code = NA,
    item = "Total",
    sessions = sum(sessions, na.rm = TRUE),
    hours = sum(hours, na.rm = TRUE),
    subtotal = sum(subtotal, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(rate = subtotal / hours)

bill <- bill %>%
  bind_rows(bill_total) %>%
  mutate(
    hours = round(hours, 1),
    subtotal = round(subtotal, 2),
    rate = round(rate, 2)
  )

bill$rate <- scales::label_currency(
  prefix = "R",
  big.mark = " ",
  decimal = "."
)(bill$rate)

bill$subtotal <- scales::label_currency(
  prefix = "R",
  big.mark = " ",
  decimal = "."
)(bill$subtotal)


flextable(bill) %>%
  set_header_labels(
    code = "Code",
    item = "Item",
    sessions = "Sessions",
    hours = "Hours",
    rate = "Rate",
    subtotal = "Subtotal"
  ) %>%
  bold(i = nrow_part(x = .)) %>%
  hline(i = nrow_part(x = .) - 1) %>%
  align(
    j = c("code", "item"),
    align = "left",
    part = "body"
  ) %>%
  align(
    j = c("code", "item"),
    align = "left",
    part = "header"
  ) %>%
  align(
    j = c("sessions", "rate", "subtotal"),
    align = "right",
    part = "body"
  ) %>%
  align(
    j = c("sessions", "rate", "subtotal"),
    align = "right",
    part = "header"
  ) %>%
  width(
    j = c("sessions", "hours", "rate", "subtotal"),
    width = .8
  ) %>%
  width(
    j = "item",
    width = 1.5
  ) %>%
  add_footer_lines(
    "Billable hours as detailed in the timesheet presented in Table B."
  ) %>%
  set_caption("Billable Hours")
```

```{r payment-instructions, results = "asis"}
instructions <- c(
  "Please transfer the amount due according to the following payment instructions:",
  "",
  paste0("**Beneficiary**: ", params$billing$beneficiary, "\\newline"),
  paste0("**Bank**: ", params$billing$bank, "\\newline"),
  paste0("**Branch**: ", params$billing$branch, "\\newline"),
  paste0("**Account**: ", params$billing$account, "\\newline"),
  paste0("**SWIFT**: ", params$billing$swift, "\\newline"),
  paste0("**Reference**: ", params$project$reference),
  "",
  "Thank you for your business.",
  "",
  "Kind regards,\\newline",
  paste0(
    "\\includegraphics[height=3em]{resources/signature.jpg}\\newline",
    ""
  ),
  params$author$name
)

cat(instructions, sep = "\n")
```

\clearpage


```{r items, eval = FALSE}
rate_x <- 300
rate_y <- 400
rate_other <- 150

items <- read_xlsx(timesheet) %>%
  mutate(Date = ymd(Date)) %>%
  filter(Include) %>%
  select(-Include) %>%
  mutate(Hours = round(Hours, 1)) %>%
  mutate(across(
    c(Begin, End),
    ~ format(as_datetime(.), "%H:%M")
  )) %>%
  group_by(Item) %>%
  summarise(
    Date = min(Date, na.rm = TRUE),
    Hours = sum(Hours, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Date) %>%
  select(-Date) %>%
  mutate(Rate = case_when(
    Item == "X" ~ rate_x,
    Item == "Y" ~ rate_y,
    TRUE ~ rate_other
  )) %>%
  mutate(Amount = Hours * Rate)

totals <- tibble(
  Item = "Total",
  Hours = sum(items$Hours, na.rm = TRUE),
  Rate = NA,
  Amount = sum(items$Amount, na.rm = TRUE)
)

items <- items %>%
  bind_rows(totals) %>%
  mutate(across(
    c(Rate, Amount),
    ~ case_when(
      !is.na(.) ~ paste0("R ", prettyNum(., big.mark = " "), ".00"),
      TRUE ~ NA_character_
    )
  ))

rm(totals, rate_other, rate_x, rate_y)

items %>%
  kbl(
    escape = TRUE,
    position = "h",
    booktabs = TRUE,
    linesep = "",
    align = "lrrr",
    table.envir = "table"
  ) %>%
  row_spec(nrow(items) - 1, hline_after = TRUE) %>%
  row_spec(nrow(items), bold = TRUE) %>%
  kable_styling(font_size = 10) %>%
  column_spec(1, width = "15em") %>%
  column_spec(c(2, 3, 4), width = "6em") %>%
  footnote(
    general = "Record of billable activities as submitted in \\\\cref{tab:timesheet} on the next page.",
    general_title = "",
    footnote_as_chunk = TRUE,
    threeparttable = TRUE,
    escape = FALSE
  )
```



```{r timesheet, eval = FALSE}
timesheet <- read_xlsx(timesheet) %>%
  mutate(Date = ymd(Date)) %>%
  mutate(Hours = round(Hours, 1)) %>%
  mutate(across(
    c(Begin, End),
    ~ format(as_datetime(.), "%H:%M")
  )) %>%
  select(Date, Item, everything()) %>%
  arrange(Date)

totals <- timesheet %>%
  group_by(Include) %>%
  summarise(Hours = sum(Hours, na.rm = TRUE)) %>%
  mutate(Include = case_when(Include ~ "Included", TRUE ~ "Excluded")) %>%
  spread(Include, Hours) %>%
  mutate(Total = Excluded + Included) %>%
  gather(Activity, Hours, seq_len(ncol(.))) %>%
  mutate(Date = NA, Item = NA, Include = c(FALSE, TRUE, TRUE), Begin = NA, End = NA)

timesheet <- timesheet %>%
  bind_rows(totals)

rm(totals)

timesheet <- timesheet %>%
  mutate(Activity = wihantemplates::escape_latex(Activity)) %>%
  mutate(
    Month = str_squish(format(Date, "%B %Y")),
    Day = str_squish(format(Date, "%e"))
  ) %>%
  select(Date, Month, Day, everything()) %>%
  arrange(Date, Begin) %>%
  mutate(Hours = sprintf("%.1f", round(Hours, 1))) %>%
  mutate(Hours = case_when(
    !Include ~ paste0(Hours, "\\textsuperscript{*}"),
    TRUE ~ Hours
  )) %>%
  select(-c(Include, Date))

timesheet %>%
  kbl(
    escape = FALSE,
    booktabs = TRUE,
    # position = "h",
    linesep = "",
    caption = "Complete record of related billable activities",
    align = "l",
    table.envir = "table"
  ) %>%
  row_spec(
    nrow(timesheet) - 3,
    hline_after = TRUE
  ) %>%
  collapse_rows(
    1:2,
    latex_hline = "none",
    row_group_label_position = "first",
    valign = "top"
  ) %>%
  kable_styling(
    font_size = 10,
    latex_options = c("repeat_header")
  ) %>%
  footnote(
    general = "\\\\textsuperscript{*}Entries excluded from the final amount.",
    general_title = "",
    footnote_as_chunk = TRUE,
    threeparttable = TRUE,
    escape = FALSE
  )
```
