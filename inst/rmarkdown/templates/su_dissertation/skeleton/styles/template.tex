%% --------------------------------------------------------------
%% Stellenbosch University Dissertation Template for R Markdown
%% WihanZA
%% wihanmarais@sun.ac.za
%% --------------------------------------------------------------

%% Document class
%% --------------------------------------------------------------
\documentclass[
12pt,
oneside,
openany,
afrikaans,
UKenglish, % default = last language list
$if(thesistype)$$thesistype$$endif$ % PhD or masters-t
]{stb-thesis}
% "~TinyTeX\texmf-dist\tex\latex\base\book.cls"

%% Configuration
%% --------------------------------------------------------------
\usepackage{etoolbox}

%% Language
%% --------------------------------------------------------------
\usepackage{babel}

%% Margins spacing
%% --------------------------------------------------------------
\usepackage[a4paper, left=1in, right=1in, top=1in, bottom=1.25in]{geometry}
\usepackage{setspace}
\usepackage[skip,parfill]{parskip}
\setstretch{1.1}
\setlength{\emergencystretch}{3em}
\providecommand{\tightlist}{\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\raggedbottom

%% Fonts math script SI units
%% --------------------------------------------------------------
\usepackage{amsmath}
\usepackage{iftex}
\ifxetex
    \usepackage[mono,vvarbb,upint,subscriptcorrection,uprightscript]{notomath}
    \usepackage[no-math]{fontspec}
    \defaultfontfeatures{Ligatures=TeX}
    \let\bm\symbfit
\else
    \usepackage[utf8]{inputenc}
    \usepackage{textcomp}
    \usepackage[T1]{fontenc}
    \usepackage{bm}
\fi
\normalfont

\usepackage{siunitx}
\sisetup{detect-all = true, detect-family = true}
\sisetup{output-decimal-marker = {.},
         group-separator = {\,},
         number-unit-product = {\,},
         inter-unit-product = \mathord{\cdot},
         exponent-product = \mathord{\times},
         separate-uncertainty = true}

%% Floats captions
%% --------------------------------------------------------------
\let\newfloat\undefined
\usepackage{floatrow}
\floatsetup[figure]{capposition=bottom}
\floatsetup[table]{capposition=top}
\usepackage[font=small]{caption}
\captionsetup[figure]{labelfont={bf},labelformat={default},labelsep=quad,name={Figure}}
\captionsetup[table]{labelfont={bf},labelformat={default},labelsep=quad,name={Table}}
\setlength{\abovecaptionskip}{0.25\baselineskip}
\setlength{\belowcaptionskip}{0.25\baselineskip}
\setlength{\floatsep}{6pt plus 6pt}
\setlength{\textfloatsep}{\floatsep}
\setlength{\intextsep}{\floatsep}

%% Headers footers page numbers footnotes
%% --------------------------------------------------------------
\usepackage{fancyhdr}
\pagestyle{fancy}
\setlength{\headheight}{14.5pt}
\fancyhead{}
\renewcommand{\chaptermark}[1]{\markboth{\chaptername\ \thechapter}{#1}}
\renewcommand{\sectionmark}[1]{}
\newcommand{\setappendixname}{\renewcommand{\chaptername}{Appendix}}
\makeatletter
\renewcommand*{\STB@numfnt}[1]{{\footnotesize\normalfont#1}}
\def\@oddfoot{\reset@font\hfil\STB@numfnt{\thepage}\hfil}%
\let\@evenfoot\@oddfoot
\makeatother
\usepackage[hang,flushmargin,multiple]{footmisc}

%% Figures graphics
%% --------------------------------------------------------------
\usepackage{graphicx}
\usepackage{wrapfig}
\makeatletter\def\fps@figure{htbp}\makeatother

%% Tables
%% --------------------------------------------------------------
\usepackage{array}
\usepackage{longtable}
\usepackage{booktabs}
\setlength{\extrarowheight}{2pt}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}

%% Colours hyperlink setup
%% --------------------------------------------------------------
\PassOptionsToPackage{hyphens}{url}
\usepackage[table,dvipsnames]{xcolor}
\definecolor{stbMaroon}{rgb}{0.38, 0.13, 0.23}
\definecolor{stbGold}{rgb}{0.72, 0.60, 0.38}
\definecolor{stbGreen}{rgb}{0.51, 0.80, 0.68}
\definecolor{stbOrange}{rgb}{0.86, 0.27, 0.02}
\definecolor{stbWine}{rgb}{0.65, 0.04, 0.24}
\definecolor{stbSoil}{rgb}{0.39, 0.20, 0.21}
\newcommand\myshade{50} % 50:50 color
\usepackage[final,unicode=true]{hyperref}
\hypersetup{bookmarks=true,
            pdftitle={$title-meta$},
            pdfauthor={$author-meta$},
            $if(colorlinks)$
            pdfborderstyle={/S/U/W 1},
            linkbordercolor=stbWine!\myshade!white,
            citebordercolor=stbWine!\myshade!white,
            filebordercolor=stbWine!\myshade!white,
            urlbordercolor=stbWine!\myshade!white,
            $else$
            colorlinks=true,
            linkcolor=black,
            citecolor=black,
            urlcolor=black,
            pdfborder={0 0 0},
            $endif$
            breaklinks=true,
            pdfcreator={WihanZA Stellenbosch University Dissertation Template}}
\urlstyle{same}
$if(highlighting-macros)$
$highlighting-macros$
$endif$

%% Cross referening citations bibliography
%% --------------------------------------------------------------
% Load after amsmath and hyperref
\usepackage[capitalize,noabbrev]{cleveref}
\usepackage[round]{natbib}
\usepackage{stb-bib}
\bibliographystyle{plainnat}
\renewcommand\bibfont{\small}
\renewcommand\bibsection{\chapter{\bibname}}

%% Title page front matter
%% --------------------------------------------------------------
\title{\bfseries\AorE{$titel$\\[1ex]\normalfont\small\itshape (``$title$'')}{$title$}}
\author{$authorshort$}{$author$}
\degree{\AorE{$graadshort$}{$degreeshort$}}{\AorE{$graad$}{$degree$}}
\address{\AorE{
        $departement$,\\
        Stellenbosch Universiteit,\\
        Privaatsak X1, Matieland 7602, Suid Afrika.}{
        $department$,\\
        Stellenbosch University,\\
        Private Bag X1, Matieland 7602, South Africa.}}
\faculty{\AorE{$fakulteit$}{$faculty$}}
\supervisor{$supervisor$}
$if(cosupervisor)$\cosupervisor{$cosupervisor$}$endif$
\setdate{$month$}{$year$}
$if(sponsor)$\SetSponsor{$sponsor$}$endif$
\makeatletter
    \addto{\captionsafrikaans}{\renewcommand\bibname{Verwysings}}
    \addto{\captionsafrikaans}{\renewcommand\contentsname{Inhoudsopgawe}}
    \addto{\captionsafrikaans}{\renewcommand\listfigurename{Lys van figure}}
    \addto{\captionsafrikaans}{\renewcommand\listtablename{Lys van tabelle}}
    \addto{\captionsUKenglish}{\renewcommand{\bibname}{References}}
    \addto{\captionsUKenglish}{\renewcommand\contentsname{Table of contents}}
    \addto{\captionsUKenglish}{\renewcommand\listfigurename{List of figures}}
    \addto{\captionsUKenglish}{\renewcommand\listtablename{List of tables}}
\makeatother
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{2}

%% Headings
%% --------------------------------------------------------------
%% \usepackage{titlesec} does not seem to work with stb-thesis
\makeatletter
\renewcommand{\STB@headfamily}{\normalfont\rmfamily}
\renewcommand\chapter{\if@openright\cleardoublepage\else\clearpage\fi
                    \thispagestyle{plain}%
                    \global\@topnum\z@
                    \@afterindentfalse
                    \secdef\@chapter\@schapter}
\def\@chapter[#1]#2{\ifnum \c@secnumdepth >\m@ne
                       \if@mainmatter
                         \refstepcounter{chapter}%
                         \typeout{\@chapapp\space\thechapter.}%
                         \addcontentsline{toc}{chapter}%
                                   {\protect\numberline{\thechapter}#1}%
                       \else
                         \addcontentsline{toc}{chapter}{#1}%
                       \fi
                    \else
                      \addcontentsline{toc}{chapter}{#1}%
                    \fi
                    \chaptermark{#1}%
                    \addtocontents{lof}{\protect\addvspace{10\p@}}%
                    \addtocontents{lot}{\protect\addvspace{10\p@}}%
                    \if@twocolumn
                      \@topnewpage[\@makechapterhead{#2}]%
                    \else
                      \@makechapterhead{#2}%
                      \@afterheading
                    \fi}
\def\@makechapterhead#1{%
  \vspace*{0.5ex}%
  {\parindent \z@ \raggedright \normalfont
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
        \LARGE\bfseries \@chapapp\space \thechapter
        \par\nobreak
        \vskip 0.5ex
      \fi
    \fi
    \interlinepenalty\@M
    \huge \bfseries #1\par\nobreak
    \vskip 1ex
  }}
\def\@schapter#1{\if@twocolumn
                   \@topnewpage[\@makeschapterhead{#1}]%
                 \else
                   \@makeschapterhead{#1}%
                   \@afterheading
                 \fi}
\def\@makeschapterhead#1{%
  \vspace*{0.5ex}%
  {\parindent \z@ \raggedright
    \normalfont
    \interlinepenalty\@M
    \huge \bfseries  #1\par\nobreak
    \vskip 1ex
  }}
\def\section{%
  \@startsection{section}{1}%
  {\z@}%
  {1ex plus 2pt minus 1pt}%
  {1ex plus 2pt minus 1pt}%
  {\STB@headfamily\Large\bfseries\raggedright}}
\def\subsection{%
  \@startsection{subsection}{2}%
  {\z@}%
  {.75ex plus 2pt minus 1pt}%
  {.75ex plus 2pt minus 1pt}%
  {\STB@headfamily\large\bfseries\raggedright}}%
\def\subsubsection{%
  \@startsection{subsubsection}{3}%
  {\z@}%
  {.75ex plus 2pt minus 1pt}%
  {.75ex plus 2pt minus 1pt}%
  {\STB@headfamily\normalsize\bfseries\raggedright}}
\makeatother


%% Nomenclature and lists
%% --------------------------------------------------------------
\usepackage{enumitem}
\usepackage[printonlyused]{acronym}
\usepackage{stb-nomencl}

%% Nomencl spacing
\makeatletter
\renewenvironment{Nomencl}{%
\list{}{%
\newlength{\NomParSep}%
\setlength{\NomGrpSep}{\baselineskip}%
\setlength{\NomItmSep}{\smallskipamount}%
\setlength{\NomParSep}{0pt}%
\setlength{\NomItmMrg}{1em}%
\setlength{\NomLblSep}{1em}%
\setlength{\labelwidth}{2cm}%
\setlength{\labelsep}{\NomLblSep}%
\setlength{\itemindent}{0pt}%
\setlength{\leftmargin}{\labelwidth+\labelsep-\itemindent+\NomItmMrg}%
\setlength{\listparindent}{\parindent}%
\setlength{\itemsep}{\NomItmSep}%
\setlength{\parsep}{\NomParSep}%
\setlength{\UnitLabelWdth}{2cm}%
\let\makelabel\NomLabel}}%
{\endlist}
\makeatother

%% Acronym short font
\makeatletter
\renewcommand*{\acsfont}[1]{\normalfont{#1}}
\makeatother

%% Acronym list remove excess line break
\makeatletter
\renewcommand*\AC@acro[1]{%
\@ifnextchar[{%
\csname AC@\AC@prefix{}@acro\endcsname{#1}%
}{%
\csname AC@\AC@prefix{}@acro\endcsname{#1}[#1]%
}%
}
\expandafter\renewcommand\csname AC@\AC@prefix{}@acro\endcsname{}
\expandafter\def\csname AC@\AC@prefix{}@acro\endcsname#1[#2]#3{%
\ifAC@nolist%
\else%
\ifnum%
\ifAC@printonlyused 1%
\else\ifAC@printonlyreused 1%
\else 0\fi\fi%
=1\relax%
\ifnum%
\ifAC@printonlyused%
    \expandafter\ifx\csname acused@#1@once\endcsname\AC@used 1 \else 0 \fi%
\else\ifAC@printonlyreused%
    \expandafter\ifx\csname acused@#1@twice\endcsname\AC@used 1 \else 0 \fi%
\else 0 \fi\fi%
=1\relax%
    \item[\protect\AC@hypertarget{#1}{%
    \AC@hyperref[acro:#1]{\aclabelfont{#2}\hfill}%
    }]\AC@hyperref[acro:#1]{#3}%
\ifAC@withpage%
    \expandafter\ifx\csname r@acro:#1\endcsname\relax%
    \PackageInfo{acronym}{%
    Acronym #1 used in text but not spelled out in
    full in text}%
\else%
    \nobreak\leaders\hbox{\(\m@th\mkern\@dotsep mu\hbox{.}\mkern\@dotsep mu\)}\hfill%
    \nobreak\hb@xt@\@pnumwidth{%
    \hfil\normalfont\normalcolor\AC@pageref{acro:#1}%
    }%
\fi%
\fi% removed \\
\fi%
\else%
\item[\protect\AC@hypertarget{#1}{\AC@hyperref[acro:#1]{\aclabelfont{#2}\hfill}}]\AC@hyperref[acro:#1]{#3}%
\fi%
\fi%
\begingroup
\def\acroextra##1{}%
\@bsphack
\ifAC@printonlyreused%
\protected@write\@auxout{}{%
\string\newacro{#1}[%
\expandafter\ifx\csname acused@#1@twice\endcsname\AC@used%
\string\AC@hyperlink{#1}{#2}%
\else%
{#2}%
\fi%
]{#3}%
}%
\else%
\protected@write\@auxout{}{%
\string\newacro{#1}[\string\AC@hyperlink{#1}{#2}]{#3}%
}%
\fi%
\@esphack
\endgroup
\ignorespaces}
\makeatother

%% Acronym group title and list spacing to match Nomencl
\makeatletter
\renewenvironment{acronym}[1][1]{%
\providecommand*{\acro}{\AC@acro}%
\providecommand*{\acroplural}{\AC@acroplural}%
\providecommand*{\acroindefinite}{\AC@acroindefinite}%
\long\def\acroextra##1{##1}%
\def\@tempa{1}\def\@tempb{#1}%
\ifx\@tempa\@tempb%
    \global\expandafter\let\csname AC@des@mark\endcsname\AC@used%
    \ifAC@nolist%
    \else%
        \setlength{\parskip}{0pt}
        \vspace{\baselineskip}%
        \textbf{Acronyms}%
        \begin{description}[labelwidth=2cm, labelsep=1em, itemindent=0pt, leftmargin=2cm+1em+0pt+1em, listparindent=\parindent, itemsep=\smallskipamount, parsep=0pt, topsep=\smallskipamount, partopsep=0pt]
    \fi%
\else%
    \begin{AC@deflist}{#1}%
\fi%
}%
{%
\ifx\AC@populated\AC@used\else%
    \ifAC@nolist%
    \else%
        \item[]\relax%
    \fi%
\fi%
\expandafter\ifx\csname AC@des@mark\endcsname\AC@used%
\ifAC@nolist%
\else%
    \end{description}%
\fi%
\else%
\end{AC@deflist}%
\fi}%
\makeatother

%% Start of document
%% --------------------------------------------------------------
\begin{document}
\frontmatter
\TitlePage

\DeclarationDate{\today}
\DeclarationPage

$if(abstract)$
\input{$abstract$}
$endif$

$if(acknowledgements)$
\input{$acknowledgements$}
$endif$

\fancyhead{}
\fancyhead[L]{\footnotesize\nouppercase{\leftmark}}
\fancyhead[R]{\footnotesize\nouppercase{\rightmark}}

\tableofcontents
\listoffigures
\listoftables

$if(nomenclature)$
\input{$nomenclature$}
$endif$

\mainmatter
\numberwithin{figure}{chapter}
\numberwithin{table}{chapter}

$body$ % includes appendix

\cleardoublepage
\backmatter
\fancyhead{}
\fancyhead[R]{\footnotesize\nouppercase{\rightmark}}
\bibliography{$for(bibliography)$$bibliography$$sep$,$endfor$}

\end{document}